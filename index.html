<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>黑胶唱片播放器 (最终优化版)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ---------------------- 基础样式重置 ---------------------- */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
      background-color: var(--color-bg);
      color: var(--color-text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 50px 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ---------------------- CSS变量与全局主题 ---------------------- */
    :root {
      --color-bg: #f4f3f1;
      --color-text: #333;
      --color-secondary: #6a11cb;
      --color-accent: #2575fc;
      --color-base: #e6e2dc;
      --color-record: #1a1a1a;
      --color-record-groove: #444;
      --color-error-bg: rgba(200, 50, 50, 0.85);
      --color-error-text: #fff;
      --shadow-light: rgba(255, 255, 255, 0.8);
      --shadow-dark: rgba(184, 181, 176, 0.6);
      --transition-fast: 0.3s ease;
      --focus-outline-color: var(--color-accent);
    }

    /* ---------------------- 播放器容器 ---------------------- */
    .container {
      width: 100%;
      max-width: 420px;
    }
    .player-section {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    /* ---------------------- 黑胶播放器主体 ---------------------- */
    .vinyl-player-wrapper {
      position: relative;
      width: 300px;
      height: 300px;
      margin-bottom: 2.5rem;
      max-width: 100%;
    }
    .player-base {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--color-base), #ffffff);
      box-shadow: 5px 5px 15px var(--shadow-dark), -5px -5px 15px var(--shadow-light),
                  inset 0 -3px 10px rgba(0, 0, 0, 0.05);
      z-index: 0;
    }

    /* ---------------------- 黑胶唱片样式 (已修改) ---------------------- */
    .record {
      position: absolute;
      width: 95%;
      height: 95%;
      top: 2.5%;
      left: 2.5%;
      border-radius: 50%;
      background-color: var(--color-record);
      background-image:
        radial-gradient(circle at center, #333 10%, transparent 50%),
        repeating-radial-gradient(
          circle at center,
          var(--color-record),
          var(--color-record) 0.8px,
          var(--color-record-groove) 0.8px,
          var(--color-record-groove) 1.1px
        );
      background-size: 100% 100%, 100% 100%;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5), inset 0 0 12px 2px rgba(30, 30, 30, 0.3),
                  0 4px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2;
      transition: box-shadow var(--transition-fast);
      will-change: transform;
      user-select: none;
      -webkit-user-drag: none;

      /* --- 应用动画，但初始状态为暂停 --- */
      animation: spin 4s linear infinite;
      animation-play-state: paused;
    }

    /* ---------------------- 黑胶唱片播放状态 (已修改) ---------------------- */
    .record.playing {
      /* --- 控制动画运行 --- */
      animation-play-state: running;
      /* --- 移除独立的动画定义，因为它已经在 .record 中定义 --- */
      /* animation: spin 4s linear infinite; */
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5), inset 0 0 12px 2px rgba(30, 30, 30, 0.3),
                  0 4px 10px rgba(0, 0, 0, 0.2), 0 0 10px rgba(255, 255, 255, 0.08);
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* ---------------------- 唱片封面 ---------------------- */
    #album-art {
      width: 35%;
      height: 35%;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid #111;
      background-color: #333;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      z-index: 4;
      position: relative;
      transition: transform var(--transition-fast);
      color: #aaa;
      font-size: 10px;
      text-align: center;
      line-height: 1.2;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .record.playing #album-art { transform: scale(1.03); }

    /* ---------------------- 唱臂 (Tonearm) ---------------------- */
    .tonearm {
      position: absolute;
      top: calc(50% - 135px);
      right: calc(50% - 135px);
      width: 1px; /* Use base as reference point */
      height: 1px;/* Use base as reference point */
      z-index: 10;
    }
    .tonearm-rotator {
      position: absolute;
      width: 180px;
      height: 20px;
      bottom: -10px; /* Center pivot vertically */
      left: -10px; /* Center pivot horizontally */
      transform-origin: 10px 10px; /* Pivot point: middle of base */
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      z-index: 1;
      transform: rotate(70deg); /* Initial resting angle */
      will-change: transform;
    }
    .tonearm-rotator.swing {
      animation: tonearm-swing 4s ease-out;
    }
    @keyframes tonearm-swing {
      0% { transform: rotate(70deg); }
      50% { transform: rotate(110deg); }
      70% { transform: rotate(95deg); }
      100% { transform: rotate(100deg); }
    }
    .tonearm-bar {
      position: absolute;
      top: 6px; /* Position bar relative to pivot */
      left: 10px; /* Start bar at pivot */
      width: 175px;
      height: 8px;
      background-color: #aaa;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      z-index: 10;
      cursor: pointer;
      will-change: transform;
    }

    /* ---------------------- 歌曲信息 ---------------------- */
    .song-info {
      text-align: center;
      margin-bottom: 1.5rem;
      width: 100%;
      padding: 0 1rem;
    }
    .song-info h2 {
      font-size: 1.2rem;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 0.2rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .song-info h4 {
      font-size: 0.9rem;
      font-weight: 400;
      color: #777;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* ---------------------- 进度条 ---------------------- */
    .progress-container {
      width: 100%;
      height: 6px;
      background-color: #e0dcd7;
      border-radius: 3px;
      margin: 0.5rem 0 1rem;
      overflow: hidden;
      box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.15);
      cursor: pointer;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, var(--color-secondary), var(--color-accent));
      border-radius: 3px;
      transition: width 0.1s linear;
    }

    /* ---------------------- 时间显示 ---------------------- */
    .time-display {
      display: flex;
      justify-content: space-between;
      width: 100%;
      padding: 0 0.5rem;
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 1.5rem;
    }

    /* ---------------------- 控制按钮 ---------------------- */
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      width: 100%;
      padding: 0 5px;
    }
    .control-group {
      display: flex;
      align-items: center;
    }
    .prev-next-group {
      gap: 15px;
    }
    .control-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .control-button {
      background: linear-gradient(145deg, var(--color-base), #fff);
      border: none;
      cursor: pointer;
      box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light),
                  inset 1px 1px 2px var(--shadow-light), inset -1px -1px 2px var(--shadow-dark);
      transition: all 0.3s ease-out;
      color: #555;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 6px;
      border-radius: 50%;
    }
    .prev-next-group .control-button {
      width: 52px;
      height: 52px;
      padding: 12px;
    }
    #play-pause-button {
      width: 119px;
      height: 52px;
      padding: 12px 20px;
      border-radius: 26px;
    }
    .control-button:hover {
      background: linear-gradient(145deg, #fff, var(--color-base));
      color: #333;
      box-shadow: 2px 2px 5px var(--shadow-dark), -2px -2px 5px var(--shadow-light);
    }
    .control-button:active,
    .control-button.playing {
      box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
      transform: translateY(1px);
      color: #444;
    }
    .control-button:focus-visible {
      outline: 2px solid var(--focus-outline-color);
      outline-offset: 2px;
    }
    .control-label {
      font-size: 0.7rem;
      color: #777;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      line-height: 1.2;
    }
    .control-button svg {
      width: 20px;
      height: 20px;
      display: block;
      fill: currentColor;
    }
    #play-pause-button .icon-pause { display: none; }
    #play-pause-button.playing .icon-play { display: none; }
    #play-pause-button.playing .icon-pause { display: inline-block; }

    /* ---------------------- 加载与错误指示 ---------------------- */
    .loading-indicator,
    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
      display: none;
    }
    .loading-indicator {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(0, 0, 0, 0.2);
      border-radius: 50%;
      border-top-color: #666;
      animation: spin 1s ease-in-out infinite;
    }
    .error-message {
      background-color: var(--color-error-bg);
      color: var(--color-error-text);
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 0.85rem;
      text-align: center;
      max-width: 80%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .vinyl-player-wrapper.loading .loading-indicator { display: block; }
    .vinyl-player-wrapper.error .error-message { display: block; }
    .vinyl-player-wrapper.empty .error-message { display: block; }

    /* ---------------------- 响应式适配 ---------------------- */
    @media (max-width: 480px) {
      body { padding: 30px 10px; }
      .vinyl-player-wrapper { width: 260px; height: 260px; margin-bottom: 2rem; }
      .tonearm { top: calc(50% - 120px); right: calc(50% - 120px); }
      .tonearm-rotator { width: 120px; /* Adjusted */ height: 16px; bottom: -8px; left: -8px; transform-origin: 8px 8px;}
      .tonearm-bar { width: 110px; left: 8px; /* Adjusted */ top: 4px; height: 6px; border-radius: 3px; }
      .song-info h2 { font-size: 1.1rem; }
      .song-info h4 { font-size: 0.85rem; }
      .prev-next-group { gap: 10px; }
      .prev-next-group .control-button { width: 46px; height: 46px; padding: 10px; }
      #play-pause-button { width: 102px; height: 46px; padding: 10px 15px; border-radius: 23px; }
      .control-label { font-size: 0.65rem; }
      .control-button svg { width: 18px; height: 18px; }
    }
    @media (max-width: 360px) {
      .vinyl-player-wrapper { width: 220px; height: 220px; }
      .tonearm { top: calc(50% - 105px); right: calc(50% - 105px); }
      .tonearm-rotator { width: 105px; /* Adjusted */ height: 14px; bottom: -7px; left: -7px; transform-origin: 7px 7px;}
      .tonearm-bar { width: 95px; left: 7px; /* Adjusted */ top: 4px; height: 6px; border-radius: 3px;}
      .controls { padding: 0; }
      .prev-next-group { gap: 8px; }
      .prev-next-group .control-button { width: 42px; height: 42px; padding: 9px; }
      #play-pause-button { width: 94px; height: 42px; padding: 9px 12px; border-radius: 21px; }
      .control-button svg { width: 16px; height: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="player-section">
      <!-- 播放器视觉区域 -->
      <div class="vinyl-player-wrapper" id="player-wrapper">
        <div class="player-base"></div>
        <div class="record" id="record">
          <img id="album-art" src="" alt="唱片封面">
        </div>
        <div class="tonearm" id="tonearm-base"> <!-- Base for positioning and angle calculation -->
          <div class="tonearm-rotator" id="tonearm-rotator">
            <div class="tonearm-bar"></div>
          </div>
        </div>
        <div class="loading-indicator"></div>
        <div class="error-message" id="error-message">音频加载失败</div>
      </div>

      <!-- 隐藏的音频元素 -->
      <audio id="audio-player" preload="metadata">
        您的浏览器不支持音频元素。
      </audio>

      <!-- 歌曲信息展示 -->
      <div class="song-info">
        <h2 id="song-title">加载中...</h2>
        <h4 id="song-artist"></h4>
      </div>

      <!-- 进度条 -->
      <div class="progress-container" id="progress-container" role="slider" aria-label="歌曲进度" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="progress-bar" id="progress-bar"></div>
      </div>

      <!-- 时间显示 -->
      <div class="time-display">
        <span id="current-time">0:00</span>
        <span id="duration">0:00</span>
      </div>

      <!-- 控制按钮 -->
      <div class="controls">
        <!-- 播放/暂停 -->
        <div class="control-group play-group">
          <div class="control-item">
            <button id="play-pause-button" class="control-button" aria-label="播放">
              <svg class="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
              <svg class="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
            </button>
            <span class="control-label" id="play-pause-label">播放</span>
          </div>
        </div>

        <!-- 上一曲/下一曲 -->
        <div class="control-group prev-next-group">
          <div class="control-item">
            <button id="prev-button" class="control-button" aria-label="上一首">
              <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"></path></svg>
            </button>
            <span class="control-label" id="prev-label">上一首</span>
          </div>
          <div class="control-item">
            <button id="next-button" class="control-button" aria-label="下一首">
              <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>
            </button>
            <span class="control-label" id="next-label">下一首</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript模块化代码 (保持不变) -->
  <script type="module">
    // 常量定义
    const TONEARM_ANGLES = { RESTING: 70, START: 100 }; // Resting and playing angles
    const TONEARM_DRAG_LIMITS = { MIN: 65, MAX: 110 }; // Allowed drag range (degrees)
    const LOAD_TRACK_DELAY = 150;

    // DOM元素缓存
    const elements = {
      audioPlayer: document.getElementById('audio-player'),
      playPauseButton: document.getElementById('play-pause-button'),
      playPauseLabel: document.getElementById('play-pause-label'),
      record: document.getElementById('record'),
      tonearmBase: document.getElementById('tonearm-base'), // Reference for pivot point
      tonearmRotator: document.getElementById('tonearm-rotator'),
      tonearmBar: document.querySelector('.tonearm-bar'),
      prevButton: document.getElementById('prev-button'),
      nextButton: document.getElementById('next-button'),
      albumArt: document.getElementById('album-art'),
      songTitle: document.getElementById('song-title'),
      songArtist: document.getElementById('song-artist'),
      progressContainer: document.getElementById('progress-container'),
      progressBar: document.getElementById('progress-bar'),
      currentTimeDisplay: document.getElementById('current-time'),
      durationDisplay: document.getElementById('duration'),
      loadingIndicator: document.querySelector('.loading-indicator'),
      errorMessage: document.getElementById('error-message'),
      playerWrapper: document.getElementById('player-wrapper')
    };

    // 播放器状态管理
    const state = {
      isPlaying: false,
      isLoading: false,
      hasError: false,
      isEmpty: false,
      currentTrackIndex: 0,
      progressAnimId: null,
      isDraggingTonearm: false, // Renamed for clarity
      tonearmDragStartAngle: 0, // Initial angle offset when drag starts
      playlist: [
        {
          title: "SoundHelix 歌曲 1",
          artist: "SoundHelix",
          audioSrc: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
          albumArt: "https://picsum.photos/seed/song1/200/200"
        },
        {
          title: "SoundHelix 歌曲 2",
          artist: "SoundHelix",
          audioSrc: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
          albumArt: "https://picsum.photos/seed/song2/200/200"
        },
        {
          title: "SoundHelix 歌曲 3",
          artist: "SoundHelix",
          audioSrc: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",
          albumArt: "https://picsum.photos/seed/song3/200/200"
        }
      ]
    };

    // 工具函数
    const utils = {
      formatTime: (seconds) => {
        const time = Math.max(0, seconds || 0);
        const minutes = Math.floor(time / 60);
        const secs = Math.floor(time % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
      },
      throttle: (func, limit) => {
        let inThrottle;
        return function(...args) {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        }
      },
      // Helper to get angle relative to the tonearm pivot
      getAngleRelativeToPivot: (clientX, clientY) => {
          const rect = elements.tonearmBase.getBoundingClientRect();
          // Calculate pivot coordinates relative to viewport
          // Note: transform-origin is 10px 10px within the rotator, which is positioned relative to tonearm-base
          const pivotX = rect.left + 10;
          const pivotY = rect.top + 10;
          // Calculate angle using atan2
          const angleRad = Math.atan2(clientY - pivotY, clientX - pivotX);
          // Convert to degrees and adjust offset if necessary (e.g., if 0 degrees isn't pointing right)
          let angleDeg = angleRad * (180 / Math.PI);
          // You might need to adjust angleDeg based on your visual setup if 0 doesn't align with expected horizontal
          return angleDeg;
      }
    };

    // 播放器核心逻辑
    const player = {
      setLoadingState(isLoading) {
        state.isLoading = isLoading;
        elements.playerWrapper.classList.toggle('loading', isLoading);
        if (isLoading) player.setErrorState(false);
        player.setControlsEnabled(!isLoading && !state.hasError && !state.isEmpty);
      },

      setErrorState(hasError, message = "音频加载失败") {
        state.hasError = hasError;
        elements.playerWrapper.classList.toggle('error', hasError);
        if (hasError) {
          elements.errorMessage.textContent = message;
          player.setLoadingState(false);
          player.updateVisuals(false);
          player.updateButtonUI(false);
        }
      },

      setEmptyState(isEmpty) {
        state.isEmpty = isEmpty;
        elements.playerWrapper.classList.toggle('empty', isEmpty);
        if (isEmpty) {
          elements.errorMessage.textContent = "播放列表为空";
          elements.songTitle.textContent = "无歌曲";
          elements.songArtist.textContent = "";
          elements.albumArt.src = "https://via.placeholder.com/200?text=Empty";
          player.setControlsEnabled(false);
        }
      },

      setControlsEnabled(enabled) {
        elements.playPauseButton.disabled = !enabled;
        elements.prevButton.disabled = !enabled;
        elements.nextButton.disabled = !enabled;
        elements.progressContainer.style.pointerEvents = enabled ? 'auto' : 'none';
        elements.tonearmBar.style.pointerEvents = enabled ? 'auto' : 'none';
        elements.tonearmBar.style.cursor = enabled ? 'pointer' : 'default';
      },

      updateButtonUI(isPlaying) {
        state.isPlaying = isPlaying;
        elements.playPauseButton.classList.toggle('playing', isPlaying);
        elements.playPauseLabel.textContent = isPlaying ? '暂停' : '播放';
        elements.playPauseButton.setAttribute('aria-label', isPlaying ? '暂停' : '播放');
      },

      updateVisuals(isPlaying) {
        // --- 这个逻辑保持不变 ---
        // 切换 playing 类会通过 CSS 控制 animation-play-state
        elements.record.classList.toggle('playing', isPlaying);
        // -------------------------

        if (!state.isDraggingTonearm) { // Only update tonearm if not currently being dragged
            if (isPlaying) {
                // Use animation only when starting play, not resuming
                if (!elements.tonearmRotator.style.transform || parseFloat(elements.tonearmRotator.style.transform.replace('rotate(', '').replace('deg)', '')) < TONEARM_ANGLES.START - 5) {
                   elements.tonearmRotator.classList.add('swing');
                   elements.tonearmRotator.addEventListener('animationend', () => {
                       elements.tonearmRotator.classList.remove('swing');
                       // Ensure final position after animation
                       if (state.isPlaying) { // Double check state in case it changed during animation
                           elements.tonearmRotator.style.transform = `rotate(${TONEARM_ANGLES.START}deg)`;
                       }
                   }, { once: true });
                } else {
                     // If already near play position, just set it directly
                     elements.tonearmRotator.style.transform = `rotate(${TONEARM_ANGLES.START}deg)`;
                }
            } else {
                elements.tonearmRotator.classList.remove('swing'); // Ensure animation is removed
                elements.tonearmRotator.style.transform = `rotate(${TONEARM_ANGLES.RESTING}deg)`;
            }
        }
      },

      updateProgressBar() {
        const { duration, currentTime } = elements.audioPlayer;
        const isValid = duration && !isNaN(duration) && duration > 0;
        const progress = isValid ? currentTime / duration : 0;

        elements.progressBar.style.width = `${progress * 100}%`;
        elements.currentTimeDisplay.textContent = utils.formatTime(currentTime);
        elements.durationDisplay.textContent = utils.formatTime(duration);
        elements.progressContainer.setAttribute('aria-valuenow', isValid ? currentTime.toFixed(0) : 0);
        elements.progressContainer.setAttribute('aria-valuemax', isValid ? duration.toFixed(0) : 100);
        elements.progressContainer.setAttribute('aria-valuetext', `当前 ${utils.formatTime(currentTime)} / 总时长 ${utils.formatTime(duration)}`);
      },

      startProgressAnimation() {
          player.stopProgressAnimation(); // Ensure no duplicates
          function animationStep() {
              if (state.isPlaying && !state.isDraggingTonearm) { // Only update if playing and not dragging
                  player.updateProgressBar();
                  state.progressAnimId = requestAnimationFrame(animationStep);
              }
          }
          state.progressAnimId = requestAnimationFrame(animationStep);
      },

      stopProgressAnimation() {
        if (state.progressAnimId) {
          cancelAnimationFrame(state.progressAnimId);
          state.progressAnimId = null;
        }
      },

      loadTrack(trackIndex, autoPlay = false) {
        if (state.isEmpty || trackIndex < 0 || trackIndex >= state.playlist.length) return;

        player.setLoadingState(true);
        state.currentTrackIndex = trackIndex;
        const track = state.playlist[trackIndex];

        elements.songTitle.textContent = track.title;
        elements.songArtist.textContent = track.artist;
        elements.audioPlayer.src = track.audioSrc;

        const img = new Image();
        img.onload = () => {
          elements.albumArt.src = img.src;
          elements.albumArt.alt = `封面: ${track.title}`;
        };
        img.onerror = () => {
          elements.albumArt.src = "https://via.placeholder.com/200?text=No+Cover";
          elements.albumArt.alt = "无法加载封面";
        };
        img.src = track.albumArt || "";

        elements.audioPlayer.load();
        elements.audioPlayer.currentTime = 0;
        player.updateProgressBar(); // Reset progress bar visually
        player.updateVisuals(false); // Reset tonearm position

        const canPlayHandler = () => {
          player.setLoadingState(false);
          // Update duration display once metadata is loaded
          player.updateProgressBar();
          if (autoPlay) player.playAudio();
        };
        elements.audioPlayer.removeEventListener('canplay', canPlayHandler); // Ensure no duplicates
        elements.audioPlayer.addEventListener('canplay', canPlayHandler, { once: true });
      },

      playAudio() {
        if (state.hasError || state.isLoading || state.isEmpty || state.isPlaying) return;

        player.setLoadingState(true);
        setTimeout(() => { // Short delay for visual effect
          elements.audioPlayer.play().then(() => {
            player.setLoadingState(false);
            player.updateButtonUI(true);
            player.updateVisuals(true); // This will toggle the .playing class on record
            player.startProgressAnimation();
          }).catch(error => {
            console.error("Playback error:", error);
            player.setErrorState(true, `播放错误: ${error.message || '播放被阻止'}`);
            player.updateVisuals(false); // Reset visuals on error
          });
        }, LOAD_TRACK_DELAY);
      },

      pauseAudio() {
        if (!state.isPlaying) return;
        elements.audioPlayer.pause();
        player.updateButtonUI(false);
        player.updateVisuals(false); // This will toggle the .playing class off record
        player.stopProgressAnimation();
      },

      playNextTrack() {
        const nextIndex = (state.currentTrackIndex + 1) % state.playlist.length;
        player.loadTrack(nextIndex, true);
      },

      playPrevTrack() {
        // Go to previous track if near beginning, otherwise restart current track
        if (elements.audioPlayer.currentTime < 3) {
          const prevIndex = (state.currentTrackIndex - 1 + state.playlist.length) % state.playlist.length;
          player.loadTrack(prevIndex, true);
        } else {
          elements.audioPlayer.currentTime = 0;
          player.updateProgressBar();
          // No need to call playAudio() if already playing, just let timeupdate handle it
          if (!state.isPlaying) {
             player.playAudio(); // Start playing if paused
          } else {
             // Ensure progress animation restarts if it was stopped by seeking
             player.startProgressAnimation();
          }
        }
      },

      handleProgressClick(e) {
        const { duration } = elements.audioPlayer;
        if (!duration || isNaN(duration) || duration <= 0 || state.isLoading || state.hasError || state.isEmpty) return;

        const rect = elements.progressContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickProgress = Math.min(1, Math.max(0, clickX / rect.width));
        elements.audioPlayer.currentTime = clickProgress * duration;
        player.updateProgressBar(); // Immediately update UI
        if (!state.isPlaying) { // If paused, update visuals to match time
             const targetAngle = TONEARM_ANGLES.RESTING + (TONEARM_ANGLES.START - TONEARM_ANGLES.RESTING) * clickProgress;
             // Clamp angle just in case
             const clampedAngle = Math.max(TONEARM_ANGLES.RESTING, Math.min(TONEARM_ANGLES.START, targetAngle));
             elements.tonearmRotator.style.transform = `rotate(${clampedAngle}deg)`;
        }
      },

      togglePlayPause() {
        if (state.isLoading || state.hasError || state.isEmpty) return;
        state.isPlaying ? player.pauseAudio() : player.playAudio();
      },

      // --- Tonearm Drag Handlers ---
      handleTonearmMouseDown(e) {
        e.preventDefault(); // Prevent text selection/default drag behavior
        if (state.isLoading || state.hasError || state.isEmpty) return;

        state.isDraggingTonearm = true;
        // Calculate the difference between the current mouse angle and the current rotation angle
        // This allows dragging to start smoothly from the current arm position
        const currentRotation = parseFloat(elements.tonearmRotator.style.transform.replace('rotate(', '').replace('deg)', '')) || TONEARM_ANGLES.RESTING;
        const mouseAngle = utils.getAngleRelativeToPivot(e.clientX, e.clientY);
        state.tonearmDragStartAngle = mouseAngle - currentRotation;

        player.stopProgressAnimation(); // Pause progress updates while dragging
        elements.tonearmRotator.classList.remove('swing'); // Stop animation if active
        elements.tonearmRotator.style.transition = 'none'; // Disable transition for smooth dragging

        // Optional: Pause audio immediately when starting drag
        // if (state.isPlaying) {
        //   elements.audioPlayer.pause();
        // }
      },

      handleTonearmMouseMove(e) {
        if (!state.isDraggingTonearm) return;

        const mouseAngle = utils.getAngleRelativeToPivot(e.clientX, e.clientY);
        let targetRotation = mouseAngle - state.tonearmDragStartAngle;

        // *** Clamp the target rotation angle ***
        targetRotation = Math.max(TONEARM_DRAG_LIMITS.MIN, Math.min(TONEARM_DRAG_LIMITS.MAX, targetRotation));

        elements.tonearmRotator.style.transform = `rotate(${targetRotation}deg)`;

        // Update audio progress based on the dragged angle within the *functional* range (RESTING to START)
        const progressRangeStart = TONEARM_ANGLES.RESTING;
        const progressRangeEnd = TONEARM_ANGLES.START;
        const progress = Math.max(0, Math.min(1,
          (targetRotation - progressRangeStart) / (progressRangeEnd - progressRangeStart)
        ));

        const { duration } = elements.audioPlayer;
        if (duration && !isNaN(duration) && duration > 0) {
            elements.audioPlayer.currentTime = progress * duration;
            player.updateProgressBar(); // Update visual progress bar and time displays
        }
      },

      handleTonearmMouseUp(e) {
        if (!state.isDraggingTonearm) return;

        state.isDraggingTonearm = false;
        elements.tonearmRotator.style.transition = ''; // Re-enable CSS transitions

        // Decide final state based on drop position
        const finalRotation = parseFloat(elements.tonearmRotator.style.transform.replace('rotate(', '').replace('deg)', '')) || TONEARM_ANGLES.RESTING;

        // If dropped within the 'play' zone (e.g., > halfway between rest and start)
        if (finalRotation >= (TONEARM_ANGLES.RESTING + TONEARM_ANGLES.START) / 2) {
            // Snap to START angle smoothly and ensure playing
            elements.tonearmRotator.style.transform = `rotate(${TONEARM_ANGLES.START}deg)`;
             if (!state.isPlaying) {
                 player.playAudio(); // Start playing if it wasn't
             } else {
                 player.startProgressAnimation(); // Resume progress animation if it was already playing
             }
        } else {
            // Snap back to RESTING angle smoothly and ensure paused
            elements.tonearmRotator.style.transform = `rotate(${TONEARM_ANGLES.RESTING}deg)`;
            if (state.isPlaying) {
                player.pauseAudio(); // Pause if it was playing
            }
        }
      }
    };

    // 事件绑定
    const setupEventListeners = () => {
      elements.playPauseButton.addEventListener('click', player.togglePlayPause);
      elements.prevButton.addEventListener('click', player.playPrevTrack);
      elements.nextButton.addEventListener('click', player.playNextTrack);

      elements.progressContainer.addEventListener('click', utils.throttle(player.handleProgressClick, 100));

      // Tonearm Interaction (Mouse)
      elements.tonearmBar.addEventListener('mousedown', player.handleTonearmMouseDown);
      document.addEventListener('mousemove', player.handleTonearmMouseMove); // Listen on document for dragging outside
      document.addEventListener('mouseup', player.handleTonearmMouseUp);     // Listen on document

      // Tonearm Interaction (Touch - Basic Implementation)
      // Note: Touch events might need more refinement for smooth experience (e.g., prevent page scroll)
      elements.tonearmBar.addEventListener('touchstart', (e) => {
          player.handleTonearmMouseDown(e.touches[0]); // Use first touch point
          e.preventDefault(); // Often needed for touch drag
      }, { passive: false });
      document.addEventListener('touchmove', (e) => {
          if (state.isDraggingTonearm) {
              player.handleTonearmMouseMove(e.touches[0]);
          }
      });
      document.addEventListener('touchend', (e) => {
          if (state.isDraggingTonearm) {
              // Use changedTouches for touchend event
              player.handleTonearmMouseUp(e.changedTouches[0]);
          }
      });


      // Keyboard Controls
      document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && !['INPUT', 'TEXTAREA', 'BUTTON'].includes(document.activeElement.tagName)) {
          e.preventDefault();
          player.togglePlayPause();
        }
        // Add Left/Right arrow keys for seeking?
        // Example:
        // if (e.code === 'ArrowLeft' && !state.isLoading) {
        //   elements.audioPlayer.currentTime = Math.max(0, elements.audioPlayer.currentTime - 5);
        //   player.updateProgressBar();
        // }
        // if (e.code === 'ArrowRight' && !state.isLoading) {
        //    elements.audioPlayer.currentTime = Math.min(elements.audioPlayer.duration || 0, elements.audioPlayer.currentTime + 5);
        //    player.updateProgressBar();
        // }
      });

      // Audio Element Events
      elements.audioPlayer.addEventListener('play', () => {
        // Update UI only if not caused by seeking/internal changes
        if (!state.isLoading) {
          player.updateButtonUI(true);
          player.updateVisuals(true);
          player.startProgressAnimation();
        }
      });
      elements.audioPlayer.addEventListener('pause', () => {
        // Update UI only if not caused by seeking/internal changes or dragging
         if (!state.isLoading && !state.isDraggingTonearm) {
             player.updateButtonUI(false);
             player.updateVisuals(false);
             player.stopProgressAnimation();
         }
      });
      elements.audioPlayer.addEventListener('ended', player.playNextTrack);
      elements.audioPlayer.addEventListener('timeupdate', () => {
          // Only update progress via timeupdate if NOT dragging tonearm
          if (!state.isDraggingTonearm) {
              player.updateProgressBar();
          }
      });
      elements.audioPlayer.addEventListener('loadedmetadata', () => {
        player.updateProgressBar(); // Update duration display
        if (!state.hasError && !state.isLoading && !state.isEmpty) {
          player.setControlsEnabled(true);
        }
      });

      elements.audioPlayer.addEventListener('error', (e) => {
        const error = elements.audioPlayer.error;
        let message = "音频加载失败";
        if (error) {
          switch (error.code) {
            case MediaError.MEDIA_ERR_ABORTED: message = "加载中止"; break; // Often happens on track change
            case MediaError.MEDIA_ERR_NETWORK: message = "网络错误"; break;
            case MediaError.MEDIA_ERR_DECODE: message = "解码错误"; break;
            case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED: message = "格式不支持"; break;
            default: message = `未知错误 (Code ${error.code})`;
          }
        }
        // Avoid showing 'Aborted' error during normal track changes
        if (error && error.code !== MediaError.MEDIA_ERR_ABORTED) {
            player.setErrorState(true, message);
        } else if (!error) {
             player.setErrorState(true, message); // Show generic error if error object is null
        }
      });

      elements.albumArt.addEventListener('error', () => {
        elements.albumArt.src = "https://via.placeholder.com/200?text=No+Cover";
        elements.albumArt.alt = "无法加载封面";
      });

    };


    // 初始化
    const init = () => {
      setupEventListeners();
      player.setControlsEnabled(false); // Initially disabled until track loads

      if (state.playlist.length === 0) {
        player.setEmptyState(true);
      } else {
        player.loadTrack(0, false); // Load first track, don't autoplay
      }
    };

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>